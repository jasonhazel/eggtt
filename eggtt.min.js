$(document).ready(function(){eggtt={init:function(){console.log("EggTT - Loaded.");},isMod:function(){return($.inArray(window.turntable.user.id,turntable.buddyList.room.roomData.metadata.moderator_id));},menu:{$main:null,init:function(){this.$main=$("ul#settings-dropdown");},add:function(d,b,c){if(this.$main===null){this.init();}var a=$("<li>").addClass("option"+(b?" eggtt-"+b:"")).attr("id","eggtt-"+d).html(c);a.prependTo(this.$main);return a;}},chattymissing:{chatty_id:"5022e5c6aaa5cd20d6000009",active:false,last_dj:null,init:function(){if(!eggtt.isMod()){return;}if($.inArray(this.chatty_id,turntable.buddyList.room.listenerids)){turntable.addEventListener("message",eggtt.chattymissing.manual);}turntable.addEventListener("message",eggtt.chattymissing.check);console.log("EggTT - Manual Queue Loaded.");},check:function(a){switch(a.command){case"registered":if(a.user.indexOf(eggtt.chattymissing.chatty_id)>-1){eggtt.api.speak("/me [AUTOMATED] Chatty is back.  Time to queue up!");eggtt.api.speak("addme");turntable.removeEventListener(eggtt.chattymissing.manual);}break;case"deregistered":if(a.user.indexOf(eggtt.chattymissing.chatty_id)>-1){eggtt.api.speak("/me [AUTOMATED] Chatty has gone missing.  Manual queue is on.");turntable.addEventListener(eggtt.chattymissing.manual);}break;}},manual:function(a){switch(a.command){case"newsong":if(eggtt.chattymissing.last_dj){eggtt.api.remDj(eggtt.chattymissing.last_dj);}eggtt.chattymissing.last_dj=a.room.metadata.current_dj;break;case"speak":a.text=a.text.trim();if(a.text.match("addme")||a.text.match("q+")){eggtt.api.speak("/me [AUTOMATED] Queue is currently manual.  FFA to get on deck. one song limit.");}break;}}},autoqueue:{active:false,bop_messages:["dance","bounce","bop","groove","jump","boom","slam"],init:function(){if(!eggtt.isMod()){return;}this.$menu=eggtt.menu.add("autoqueue",null,"Auto Queue").css("color","green ");this.$menu.click(this.toggle);console.log("EggTT - Autoqueue Loaded");},listener:function(b){switch(b.command){case"rem_dj":if(b.user[0].userid==turntable.user.id){setTimeout(function(){eggtt.api.speak("addme");},5000);}break;case"newsong":if(b.room.metadata.current_dj===window.turntable.user.id){var a=Math.floor(Math.random()*eggtt.autoqueue.bop_messages.length);setTimeout(function(){eggtt.api.speak(eggtt.autoqueue.bop_messages[a]);},5000);}break;}},toggle:function(){if(eggtt.autoqueue.active){eggtt.autoqueue.active=false;eggtt.autoqueue.$menu.css("color","red");turntable.removeEventListener("message",eggtt.autoqueue.listener);}else{eggtt.autoqueue.active=true;eggtt.autoqueue.$menu.css("color","green");turntable.addEventListener("message",eggtt.autoqueue.listener);eggtt.api.speak("addme");}}},api:{send:function(d,c){if(d.api=="room.now"){return;}d.msgid=turntable.messageId++;d.clientid=turntable.clientId;if(turntable.user.id&&!d.userid){d.userid=turntable.user.id;d.userauth=turntable.user.auth;}var b=JSON.stringify(d);if(turntable.socketVerbose){LOG(util.nowStr()+" Preparing message "+b);}var a=$.Deferred();
turntable.whenSocketConnected(function(){if(turntable.socketVerbose){LOG(util.nowStr()+" Sending message "+d.msgid+" to "+turntable.socket.host);}if(turntable.socket.transport.type=="websocket"){turntable.socketLog(turntable.socket.transport.sockets[0].id+":<"+d.msgid);}turntable.socket.send(b);turntable.socketKeepAlive(true);turntable.pendingCalls.push({msgid:d.msgid,handler:c,deferred:a,time:util.now()});});return a.promise();},vote:function(h){var a=$.sha1(turntable.buddyList.room.roomId+h+turntable.buddyList.room.currentSong._id);var g=$.sha1(Math.random()+"");var b=$.sha1(Math.random()+"");this.send({api:"room.vote",roomid:turntable.buddyList.room.roomId,section:turntable.buddyList.room.section,val:h,vh:a,th:g,ph:b});},speak:function(a){this.send({api:"room.speak",roomid:turntable.buddyList.room.roomId,text:a.toString()});},addDj:function(){this.send({api:"room.add_dj",roomid:turntable.buddyList.room.roomId});},remDj:function(a){this.send({api:"room.rem_dj",roomid:turntable.buddyList.room.roomId,djid:a});},up:function(){this.vote("up");},down:function(){this.vote("down");}}};eggtt.init();eggtt.autoqueue.init();eggtt.chattymissing.init();});